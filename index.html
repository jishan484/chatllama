<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1" />
  <script>if (window.innerWidth < (_a_ = 390)) document.querySelector('meta[name="viewport"]').setAttribute('content', 'width=' + _a_ + ', initial-scale=1.0, user-scalable=no, minimum-scale=' + (window.innerWidth / _a_) + ', maximum-scale=' + (window.innerWidth / _a_));</script>
  <title>llamaUI : UI</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.24/dist/full.min.css" rel="stylesheet" />
  <link rel="icon" type="image/png" href="asset/logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Optional: Additional styles for the default message */
    .default-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #6b7280;
      /* Tailwind gray-500 */
    }

    /* Ensure code blocks are scrollable horizontally */
    pre {
      overflow-x: auto;
      white-space: pre-wrap;
      /* Optional: allow wrapping if desired */
      word-break: break-all;
      position: relative;
      /* For positioning the copy button */
    }

    #modelSelect {
      max-width: 160px;
    }

    /* Style for the copy button */
    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      border: none;
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 4px;
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.3s ease;
    }

    pre:hover .copy-btn {
      opacity: 1;
    }

    /* Adjust the chatbox so that long content doesn't break layout */
    #chatbox {
      overflow-x: hidden;
      max-width: 100%;
      max-height: calc(100% - 121px);
    }

    /* Styles for the command suggestion box */
    #commandSuggestions {
      position: absolute;
      bottom: 82px;
      /* adjust to position above the input area */
      left: 2.5rem;
      background-color: var(--p);
      padding: 0.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 1.1);
      pointer-events: none;
      /* allows user to click through */
      z-index: 50;
      opacity: 0.8;
    }

    think {
      color: gray;
    }

    .textarea-wrapper {
      position: relative;
      display: flex;
      width: 100%;
    }

    .upload-btn {
      position: absolute;
      right: 0.7rem;
      bottom: 0.45rem;
      background: transparent;
      border: none;
      cursor: pointer;
      height: 2rem;
      width: 2rem;
    }

    #userInput::-webkit-scrollbar,
    #chatbox::-webkit-scrollbar {
      display: none;
    }

    #userInput,
    #chatbox {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    #filePreview {
      position: absolute;
      top: -60px;
      right: 3px;
      width: 50px !important;
      height: 50px;
    }

    #filePreview img {
      position: absolute;
      bottom: 0;
      background: linear-gradient(45deg, #7480ff, #ff52d9);
    }

    .commandButtons {
      position: absolute;
      right: 0.66rem;
      top: -3.5rem;
      padding: 5px;
    }
  </style>
</head>

<body>
  <div class="flex flex-col h-screen relative">
    <!-- Navbar with New Chat, Status, and Model Selector -->
    <div class="navbar bg-base-200 flex justify-between items-center sticky top-0 z-50">
      <div class="flex items-center gap-2">
        <a class="btn btn-ghost bg-base-300 text-xl">
          <img src="asset/logo.png" alt="llamaUI Logo" class="h-10 w-10" />
          <b class="text-primary hidden sm:inline">llama<span class="text-secondary">U!</span></b>
        </a>
        <button id="statusBtn" class="btn btn-sm btn-secondary hidden sm:inline">Status</button>
        <button id="newChatBtn" class="btn btn-sm btn-primary">New Chat</button>
      </div>
      <div>
        <select id="modelSelect" class="select select-bordered select-sm bg-primary text-black mx-2">
          <option disabled selected>Select a model</option>
        </select>
      </div>
    </div>

    <!-- Main Chat Area (fixed max width 100%) -->
    <div id="chatbox" class="flex-grow overflow-y-auto p-4" style="max-width: 100%;"></div>

    <!-- Input Area -->
    <div class="p-4 border-t border-base-300 bg-base-200 relative" style="position: fixed; bottom: 0; width: 100%;">
      <form id="inputArea" class="flex gap-2" onsubmit="event.preventDefault(); sendMessage();">
        <div class="textarea-wrapper">
          <textarea id="userInput" class="textarea textarea-bordered flex-1 pr-10" rows="1"
            placeholder="Type your message..."></textarea>
          <div id="filePreview"></div>
          <button id="uploadBtn" type="button" class="upload-btn" title="Upload an Image">
            <img src="asset/image.png" class="h-7 w-7">
          </button>
          <input id="fileInput" type="file" class="hidden"
            accept=".jpeg,.jpg,.png,.webp,image/jpeg,image/png,image/webp" />
        </div>
        <button id="sendBtn" type="button" class="btn btn-primary" onclick="sendMessage()">Send</button>
      </form>
      <!-- app command buttons -->
      <button class="btn btn-sm btn-circle border-gray-700 w-10 h-10 commandButtons" title="App Settings"
        style="top: -7rem;" onclick="showAppSettings()"><img src="asset/settings.png" class="h-6 w-6"></button>
      <button class="btn btn-sm btn-circle border-gray-700 w-10 h-10 commandButtons" title="Tools">
        <img src="asset/options.png" class="h-5 w-5"></button>
      <!-- Command Suggestions (non-modal, non-blocking) -->
      <div id="commandSuggestions" class="hidden">
        <div class="flex flex-col items-start gap-1">
          <a class="btn btn-sm text-sm w-full flex items-center justify-start">
            <img src="asset/web.png" class="h-4 w-4 mr-2" alt="Web Icon">/Web
          </a>
          <a class="btn btn-sm text-sm w-full flex items-center justify-start">
            <img src="asset/code.png" class="h-4 w-4 mr-2" alt="Code Icon">/Full Code
          </a>
          <a class="btn btn-sm text-sm w-full flex items-center justify-start">
            <img src="asset/think.png" class="h-4 w-4 mr-2" alt="Deep Think Icon">/Deep Think
          </a>
        </div>
      </div>

    </div>

    <!-- Modal for Status (hidden by default) -->
    <input type="checkbox" id="psModalToggle" class="modal-toggle" />
    <div class="modal" style="backdrop-filter: blur(1px);">
      <div class="modal-box relative">
        <label for="psModalToggle" class="btn btn-sm btn-circle absolute right-2 top-2">✕</label>
        <h3 class="text-lg font-bold mb-4">System Status</h3>
        <div id="psModalContent">
          <!-- RAM usage and expiry data will be inserted here -->
          <p>Loading status...</p>
        </div>
      </div>
    </div>

    <!-- Settings Modal Toggle -->
    <input type="checkbox" id="settingsModalToggle" class="modal-toggle" />
    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
      <div class="modal-box w-96 max-w-full">
        <h3 class="font-bold text-lg">Settings</h3>
        <div id="settingsModalContent" class="mt-4">
          <div class="flex flex-col h-full">
            <div class="flex-1 overflow-y-auto space-y-4 pr-1 text-primary text-sm pb-32">
              <!-- CPU Usage -->
              <div class="card bg-base-200 p-3 shadow">
                <div class="flex justify-between items-center">
                  <div>
                    <h2 class="font-semibold text-base">Full CPU Usage</h2>
                    <p class="text-xs text-base-content/60">Workaround for Ollama Bug #2929</p>
                  </div>
                  <input type="checkbox" id="cpuFullUsage" class="toggle toggle-sm toggle-success">
                </div>
              </div>
              <!-- Remember Model or Not -->
              <div class="card bg-base-200 p-3 shadow">
                <div class="flex justify-between items-center">
                  <div>
                    <h2 class="font-semibold text-base">Remember Current Model</h2>
                    <p class="text-xs text-base-content/60">Enable this to remember the selected model across sessions.</p>
                  </div>
                  <input type="checkbox" id="rememberCurrentModel" class="toggle toggle-sm toggle-success">
                </div>
              </div>
              <!-- Conversation History Depth -->
              <div class="card bg-base-200 p-3 shadow">
                <div class="flex justify-between items-center gap-2">
                  <div>
                    <h2 class="font-semibold text-base">Conversation History Depth</h2>
                    <p class="text-xs text-base-content/60">Number of past messages sent to model in each API request
                    </p>
                  </div>
                  <input type="number" id="chatHistoryCount" class="input input-sm input-bordered w-16 text-center"
                    min="2" value="6">
                </div>
              </div>
              <!-- UI Theme & Layout (Coming Soon) -->
              <div class="card bg-base-200 p-3 shadow opacity-50 pointer-events-none">
                <div class="flex justify-between items-center">
                  <div>
                    <h2 class="font-semibold text-base">UI Theme & Layout</h2>
                    <p class="text-xs text-base-content/60">Customization Coming Soon</p>
                  </div>
                  <button class="btn btn-xs btn-outline">TBD</button>
                </div>
              </div>
              <!-- Shortcut Keys (Coming Soon) -->
              <div class="card bg-base-200 p-3 shadow opacity-50 pointer-events-none">
                <div class="flex justify-between items-center">
                  <div>
                    <h2 class="font-semibold text-base">Shortcut Keys</h2>
                    <p class="text-xs text-base-content/60">Assign your own shortcuts</p>
                  </div>
                  <button class="btn btn-xs btn-outline">TBD</button>
                </div>
              </div>
              <!-- Vision Model Image Size -->
              <div class="card bg-base-200 p-3 shadow">
                <div>
                  <h2 class="font-semibold text-base mb-1">Vision Model Image Size</h2>
                  <select id="visionImageSize" class="select select-sm select-bordered w-full">
                    <option>Original Size</option>
                    <option>1024x1024</option>
                    <option>512x512</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="pt-3 border-t border-base-300 flex justify-between items-center bg-base-100 sticky bottom-0">
          <div class="modal-action w-100 w-full flex justify-between items-center">
            <button id="saveSettingsBtn" class="btn btn-sm btn-primary">Save & Apply</button>
            <label for="settingsModalToggle" class="btn btn-sm btn-ghost">Close</label>
          </div>
        </div>
      </div>
    </div>

    <!-- Default Message: Visible until the first message is sent -->
    <div id="defaultMessage" class="default-message">
      <p class="mb-2">
        <center>
          <img src="asset/logo.png" alt="llamaUI Logo" class="h-40 w-40"
            style="filter: grayscale(0.8) brightness(1.3) contrast(0.8) blur(0.2px);" />
        </center>
      </p>
      <p class="mb-2 font-semibold text-xl">Welcome to llamaUI 1.0!</p>
      <p class="mb-2">Type your message to start chatting.</p>
      <p class="text-sm">Shortcuts: <br>
        - <strong>Ctrl+D</strong>: New Chat<br>
        - <strong>Ctrl+S</strong>: Stop streaming<br>
        - <strong>Enter</strong>: Send message
      </p>
    </div>
  </div>

  <script>
    // Set marked options to use highlight.js for code blocks.
    marked.setOptions({
      highlight: function (code, lang) {
        const validLang = hljs.getLanguage(lang) ? lang : 'plaintext';
        return hljs.highlight(code, { language: validLang }).value;
      }
    });

    marked.use({
      extensions: [{
        name: 'thinkBlock',
        level: 'block',
        start(src) {
          return src.indexOf('<think>');
        },
        tokenizer(src) {
          const match = /^<think>([\s\S]*?)<\/think>/i.exec(src);
          if (!match) return;

          return {
            type: 'thinkBlock',
            raw: match[0],
            text: match[1],
            tokens: this.lexer.blockTokens(match[1])
          };
        },
        renderer(token) {
          return `<think>${marked.parser(token.tokens)}</think>`;
        }
      }]
    });

    // Cache frequently accessed DOM elements.
    const modelSelect = document.getElementById("modelSelect");
    const chatbox = document.getElementById("chatbox");
    const userInput = document.getElementById("userInput");
    const newChatBtn = document.getElementById("newChatBtn");
    const sendBtn = document.getElementById("sendBtn");
    const statusBtn = document.getElementById("statusBtn");
    const psModalContent = document.getElementById("psModalContent");
    const psModalToggle = document.getElementById("psModalToggle");
    const commandSuggestions = document.getElementById("commandSuggestions");
    const imageFilePreview = document.getElementById('filePreview');
    const app_config = {
      ALLOWED_NUM_THREAD: 4,
      MAX_CHAT_HISTORY: 5,
      USE_MAX_CPU: false,
      DEEP_THINK: false,
      VISION_IMAGE_SIZE: 'Original Size',
      CURRENT_MODEL: null,
      REMEMBER_CURRENT_MODEL: false
    }
    let defaultMessage = document.getElementById("defaultMessage");
    let imageInput = {
      isApplicable: false,
      image: null
    }

    // Global chat state and streaming control.
    let currentChatHistory = [];
    let controller = new AbortController();
    let isStreaming = false;
    let previousModel = ""; // Store the previously selected model.

    // Utility sectuion: <
    function escapeHtml(unsafe) {
      return unsafe.replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function copyToClipboard(el) {
      const text = el.innerText || el.textContent;
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).catch(() => { });
      } else {
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.top = "-9999px";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        try { document.execCommand("copy"); } catch (e) { }
        document.body.removeChild(ta);
      }
    }

    function timeLeft(targetDateStr) {
      const targetDate = new Date(targetDateStr);
      const now = new Date();
      const timeDiff = targetDate - now; // Difference in milliseconds

      if (timeDiff <= 0) {
        return "Already Expired!";
      }

      const seconds = Math.floor((timeDiff / 1000) % 60);
      const minutes = Math.floor((timeDiff / (1000 * 60)) % 60);

      return `${minutes} minutes, ${seconds} seconds left`;
    }
    //End of Utility section:>

    // Update send button based on whether a response is streaming.
    function updateSendButton() {
      if (isStreaming) {
        sendBtn.textContent = "Stop";
        sendBtn.onclick = stopCurrentStreaming;
        sendBtn.className = 'btn btn-secondary';
      } else {
        sendBtn.textContent = "Send";
        sendBtn.onclick = sendMessage;
        sendBtn.className = 'btn btn-primary';
      }
    }

    async function fetchCPU() {
      const response = await fetch(location.href + "/internal/cpu");
      const data = await response.json();
      app_config.ALLOWED_NUM_THREAD = data?.cpu_count;
    }
    // Fetch available models.
    async function fetchModels() {
      try {
        const response = await fetch(location.href + "/api/tags");
        const data = await response.json();
        modelSelect.innerHTML = data.models.sort((a, b) => a.size - b.size)
          .map(model => `<option value="${model.name}"${(app_config.REMEMBER_CURRENT_MODEL && model.name == app_config.CURRENT_MODEL)?' selected':''}>${model.name.split(":")[0]} : ${model.name.split(":")[1]}</option>`)
          .join('');
        // Initialize previousModel and select the first model.
        // previousModel = data.models[0]?.name || "";
        // modelSelect.value = previousModel;
        fetchCPU();
      } catch (error) {
        console.error("Error fetching models:", error);
      }
    }

    // Abort any ongoing streaming response.
    function stopResponse() {
      controller.abort();
      controller = new AbortController();
    }

    // Stop streaming response when the Stop button is pressed.
    function stopCurrentStreaming() {
      stopResponse();
      isStreaming = false;
      updateSendButton();
    }

    // Unload a model from memory.
    async function unloadModel(modelName) {
      try {
        await fetch(location.href + "/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ model: modelName, messages: [], keep_alive: 0 })
        });
        console.log("Unloaded model:", modelName);
      } catch (error) {
        console.error("Error unloading model:", error);
      }
    }

    // Function to add copy buttons to all code blocks.
    function addCopyButtons() {
      document.querySelectorAll("pre").forEach(pre => {
        // Prevent adding duplicate buttons.
        if (pre.querySelector(".copy-btn")) return;
        const button = document.createElement("button");
        button.className = "copy-btn";
        button.textContent = "Copy";
        button.addEventListener("click", () => {
          copyToClipboard(button.parentElement.getElementsByTagName('code')[0]);
          button.textContent = "Copied!";
          setTimeout(() => {
            button.textContent = "Copy";
          }, 2000);
        });
        pre.appendChild(button);
      });
    }

    // Process streaming API responses.
    async function processResponse(response, contentElement) {
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let partialText = "";

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true }).trim();
        const jsonObjects = chunk.split("\n")
          .filter(line => line.trim())
          .map(line => {
            try {
              return JSON.parse(line);
            } catch (err) {
              console.error("JSON parsing error:", err, "Chunk:", line);
              return null;
            }
          }).filter(obj => obj !== null);

        for (const obj of jsonObjects) {
          const newResponseText = obj.response || (obj.message && obj.message.content);
          if (newResponseText) {
            partialText += newResponseText;
            // Update container with parsed Markdown.
            contentElement.innerHTML = marked.parse(partialText);
            // Apply syntax highlighting to all code blocks.
            contentElement.querySelectorAll("pre code").forEach((block) => {
              hljs.highlightElement(block);
            });
            // Add copy buttons to code blocks.
            addCopyButtons();
            chatbox.scrollTop = chatbox.scrollHeight;
          }
        }
      }
      return partialText;
    }

    // Call the /api/generate endpoint for the first message.
    async function generateResponse(message, selectedModel) {
      return fetch(location.href + "/api/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: selectedModel,
          prompt: message,
          images: (imageInput.isApplicable) ? [imageInput.image?.split(';base64,')[1]] : null,
          options: (app_config.USE_MAX_CPU) ? { "num_thread": app_config.ALLOWED_NUM_THREAD } : null
        }),
        signal: controller.signal
      });
    }

    // Call the /api/chat endpoint for subsequent messages.
    async function chatResponse(selectedModel, history) {
      return fetch(location.href + "/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ model: selectedModel, messages: history, options: (app_config.USE_MAX_CPU) ? { "num_thread": app_config.ALLOWED_NUM_THREAD } : null }),
        signal: controller.signal
      });
    }

    // Append a user message to the chatbox with HTML escaped.
    function appendUserMessage(message) {
      // Remove the default message if it's visible.
      if (defaultMessage) {
        defaultMessage.remove();
      }
      const userMessageEl = document.createElement("div");
      userMessageEl.className = "chat-message flex flex-row mb-4";
      const avatar = `<div class="avatar">
                <div class="w-8 h-8 mt-2 rounded-full flex items-center justify-center">
                  <img src="asset/user.png">
                </div>
              </div>`;
      const messageContainer = document.createElement("div");
      messageContainer.className = "bg-base-200 text-base-content rounded-lg p-3 flex-1 ml-2";
      messageContainer.textContent = message;
      userMessageEl.innerHTML = avatar;
      userMessageEl.appendChild(messageContainer);
      chatbox.appendChild(userMessageEl);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    // Create and append the assistant's reply container with a skeleton loader.
    function createAssistantMessageContainer() {
      const aiMessageEl = document.createElement("div");
      aiMessageEl.className = "chat-message flex flex-row-reverse mb-4";
      aiMessageEl.innerHTML = `
              <div class="avatar">
                <div class="w-8 h-8 mt-2 rounded-full flex items-center justify-center bg-base-300 text-base-content">
                  <span class="material-icons text-lg"><img src="asset/ollama.png"></span>
                </div>
              </div>
              <div class="bg-base-300 text-base-content rounded-lg p-3 flex-1 mr-2 message-content">
                <!-- Skeleton loader -->
                <div class="animate-pulse space-y-2">
                  <div class="h-4 bg-gray-600 rounded w-3/4"></div>
                  <div class="h-4 bg-gray-800 rounded w-5/6"></div>
                </div>
              </div>
              `;
      chatbox.appendChild(aiMessageEl);
      chatbox.scrollTop = chatbox.scrollHeight;
      return aiMessageEl.querySelector(".message-content");
    }

    // Main function to send a message.
    async function sendMessage() {
      const message = userInput.value.trim();
      const selectedModel = modelSelect.value;
      if (!message) return;
      userInput.value = "";

      // Hide command suggestions (if visible) once a message is sent.
      commandSuggestions.classList.add("hidden");

      // Append user message and immediately create the assistant message container with skeleton loader.
      appendUserMessage(message);
      const messageContentDiv = createAssistantMessageContainer();
      if (imageInput.isApplicable) currentChatHistory.push({ role: "user", content: message, images: (imageInput.isApplicable) ? [imageInput.image?.split(';base64,')[1]] : null });
      else currentChatHistory.push({ role: "user", content: message });

      isStreaming = true;
      updateSendButton();

      let response;
      try {
        response = currentChatHistory.length === 1
          ? await generateResponse(message, selectedModel)
          : await chatResponse(selectedModel, currentChatHistory);
        if (!response.ok) throw new Error("Server error: " + response.status);

        const fullResponseText = await processResponse(response, messageContentDiv);
        currentChatHistory.push({ role: "assistant", content: fullResponseText });
      } catch (error) {
        if (error.name !== "AbortError") {
          console.error("Error fetching response:", error);
          messageContentDiv.innerHTML = `<p class="text-error">Error fetching response: ${error.message}</p>`;
        }
      } finally {
        isStreaming = false;
        updateSendButton();
        resetUploadButton();
        clearCurrentChatHistory();
      }
    }

    // Event: New Chat clears chat history and UI, and shows the default message.
    newChatBtn.addEventListener("click", () => {
      currentChatHistory = [];
      chatbox.innerHTML = "";
      // Reinstate the default welcome message.
      const defaultHTML = `
              <div id="defaultMessage" class="default-message">
                <p class="mb-2">
                  <center>
                    <img src="asset/logo.png" alt="llamaUI Logo" class="h-40 w-40" style="filter: grayscale(0.8) brightness(1.3) contrast(0.8) blur(0.2px);" />
                  </center>
                </p>
                <p class="mb-2 font-semibold text-xl">Welcome to llamaUI 1.0!</p>
                <p class="mb-2">New Chat Session Started! Type your message to start chatting.</p>
                <p class="text-sm">Shortcuts: <br>
                  - <strong>Ctrl+D</strong>: New Chat<br>
                    - <strong>Ctrl+S</strong>: Stop streaming<br>
                      - <strong>Enter</strong>: Send message
                    </p>
                  </div>
                  `;
      if (defaultMessage) defaultMessage.remove();
      chatbox.insertAdjacentHTML('afterbegin', defaultHTML);
      defaultMessage = document.getElementById("defaultMessage");
    });

    // Key event: Enter (without Shift) sends message.
    userInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });

    // Listen for "/" key in the text area to display command suggestions.
    userInput.addEventListener("keyup", (event) => {
      // If the only character is "/" show suggestions, otherwise hide them.
      if (userInput.value.trim() === "/") {
        commandSuggestions.classList.remove("hidden");
      } else {
        commandSuggestions.classList.add("hidden");
      }
    });

    // Global key events.
    document.addEventListener("keydown", (event) => {
      // Note: Ctrl+Shift+N is reserved by Edge for InPrivate windows.
      // Consider using an alternative combination if needed.
      if (event.ctrlKey && event.key.toLowerCase() === "d") {
        event.preventDefault();
        newChatBtn.click();
      }
      // Ctrl+S stops streaming.
      if (event.ctrlKey && event.key.toLowerCase() === "s") {
        event.preventDefault();
        if (isStreaming) {
          stopCurrentStreaming();
        }
      }
      if (!(event.ctrlKey && event.key.toLowerCase() === "c") && document.activeElement !== userInput && /^[a-zA-Z0-9]$/i.test(event.key)) {
        userInput.focus();
      }
    });

    // On model change, unload the previous model if an assistant response has been received.
    modelSelect.addEventListener("change", async () => {
      const newModel = modelSelect.value;
      const hasAssistantReply = currentChatHistory.some(msg => msg.role === "assistant");
      // Unload previous model if an assistant response exists and previousModel differs from new selection.
      if (hasAssistantReply && previousModel && previousModel !== newModel) {
        await unloadModel(previousModel);
      }
      if(app_config.REMEMBER_CURRENT_MODEL) {
        app_config.CURRENT_MODEL = newModel;
        localStorage.setItem("app_config", JSON.stringify(app_config));
      }
      previousModel = newModel;
    });

    function resetUploadButton() {
      document.getElementById('uploadBtn').innerHTML = '<img src="asset/image.png" class="h-7 w-7">';
      document.getElementById('fileInput').value = '';
      document.getElementById('uploadBtn').style.background = 'transparent';
      imageFilePreview.innerHTML = '';
      imageInput.isApplicable = false;
      imageInput.image = null;
    }

    function clearCurrentChatHistory() {
      if (currentChatHistory.length > (app_config.MAX_CHAT_HISTORY * 2)) {
        currentChatHistory.splice(0, 2);
      }
    }

    document.getElementById('uploadBtn').addEventListener('click', () => {
      if (document.getElementById('uploadBtn').innerText != 'X')
        document.getElementById('fileInput').click();
      else {
        resetUploadButton();
      }
    });

    document.getElementById('fileInput').addEventListener('change', (e) => {
      document.getElementById('uploadBtn').innerText = 'X';
      document.getElementById('uploadBtn').style.background = 'rgb(16 185 129 / 17%)';
      console.log(e.target.files)
      if (e.target.files[0] && e.target.files[0].type.startsWith('image')) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          imageFilePreview.appendChild(img);
          imageInput.isApplicable = true;
          imageInput.image = e.target.result;
        }
        reader.readAsDataURL(e.target.files[0]);
      }
    });

    // Show status modal and fetch system details.
    statusBtn.addEventListener("click", async () => {
      // Open the modal.
      psModalToggle.checked = true;
      psModalContent.innerHTML = "<p>Loading status...</p>";
      try {
        const response = await fetch(location.href + "/api/ps");
        const data = await response.json();
        // Build HTML to display the ps data.
        if (data.models && data.models.length > 0) {
          let html = '<table class="table w-full text-primary"><thead><tr><th>Model</th><th>VRAM Usage</th><th>Expires In</th></tr></thead><tbody>';
          data.models.forEach(model => {
            html += `<tr>
                      <td>${model.name}</td>
                      <td>${model.size_vram}</td>
                      <td>${timeLeft(model.expires_at)}</td>
                    </tr>`;
          });
          html += '</tbody>';

          html += '<thead><tr><th>Q_level</th><th>Param Size</th><th>Family</th></tr></thead><tbody class="text-secondary">';
          data.models.forEach(model => {
            html += `<tr>
                      <td>${model.details.quantization_level}</td>
                      <td>${model.details.parameter_size}</td>
                      <td>${model.details.family}</td>
                    </tr>`;
          });
          html += '</tbody></table>';

          psModalContent.innerHTML = html;
        } else {
          psModalContent.innerHTML = "<p>No system data available.</p>";
        }
      } catch (error) {
        psModalContent.innerHTML = `<p>Error fetching status: ${error.message}</p>`;
      }
    });


    // Load saved config from localStorage on startup
    const savedConfig = localStorage.getItem("app_config");
    if (savedConfig) {
      const parsedConfig = JSON.parse(savedConfig);
      Object.assign(app_config, parsedConfig);
      console.log("✔️Loaded settings from localStorage:", app_config);
    }

    // Settings Button Click Event
    function showAppSettings() {
      settingsModalToggle.checked = true;
      document.getElementById("cpuFullUsage").checked = app_config.USE_MAX_CPU;
      document.getElementById("rememberCurrentModel").checked = app_config.REMEMBER_CURRENT_MODEL;
      document.getElementById("chatHistoryCount").value = app_config.MAX_CHAT_HISTORY;
      document.getElementById("visionImageSize").value = app_config.VISION_IMAGE_SIZE;
      // Save Settings Handler
      document.getElementById("saveSettingsBtn").addEventListener("click", () => {
        app_config.USE_MAX_CPU = document.getElementById("cpuFullUsage").checked;
        app_config.REMEMBER_CURRENT_MODEL = document.getElementById("rememberCurrentModel").checked;
        app_config.MAX_CHAT_HISTORY = parseInt(document.getElementById("chatHistoryCount").value) || 1;
        app_config.VISION_IMAGE_SIZE = document.getElementById("visionImageSize").value;
        // Save entire config to localStorage
        localStorage.setItem("app_config", JSON.stringify(app_config));
        settingsModalToggle.checked = false;
      });
    }

    // Initialize models on page load.
    fetchModels();
  </script>
</body>

</html>